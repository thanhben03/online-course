# Nginx Configuration for Large File Upload (1GB+)
# File: nginx-large-file-upload.conf
# Sử dụng cho VPS với Node.js backend

server {
    listen 80;
    server_name nhatminhanh.tech;  # Thay bằng domain của bạn
    
    # Tăng giới hạn file upload lên 5GB
    client_max_body_size 5G;
    
    # Tăng timeout cho upload file lớn
    client_body_timeout 1800s;      # 30 phút
    client_header_timeout 1800s;    # 30 phút
    keepalive_timeout 1800s;        # 30 phút
    send_timeout 1800s;             # 30 phút
    
    # Tăng buffer size cho file lớn
    client_body_buffer_size 1M;     # Buffer 1MB
    client_header_buffer_size 4k;
    large_client_header_buffers 8 16k;
    
    # Tắt buffering để streaming upload
    proxy_request_buffering off;
    proxy_buffering off;
    
    # Proxy timeout settings
    proxy_connect_timeout 1800s;
    proxy_send_timeout 1800s;
    proxy_read_timeout 1800s;
    
    # Gzip compression (tắt cho upload)
    gzip off;
    
    # Location cho upload APIs
    location /api/upload {
        # Proxy đến Next.js server
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Tắt buffering cho upload
        proxy_request_buffering off;
        proxy_buffering off;
        
        # Headers cho large file upload
        proxy_set_header Content-Length $content_length;
        proxy_set_header Content-Type $content_type;
        
        # Timeouts cho upload
        proxy_connect_timeout 1800s;
        proxy_send_timeout 1800s;
        proxy_read_timeout 1800s;
    }
    
    # Location cho admin upload
    location /admin {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 1800s;
        proxy_send_timeout 1800s;
        proxy_read_timeout 1800s;
    }
    
    # Default location
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Standard timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Error pages
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /var/www/html;
    }
    
    # Logs cho debugging
    access_log /var/log/nginx/upload_access.log;
    error_log /var/log/nginx/upload_error.log;
}

# Nginx main config additions
# Thêm vào /etc/nginx/nginx.conf trong http block:

http {
    # Tăng hash bucket size
    server_names_hash_bucket_size 128;
    
    # Tối ưu cho file lớn
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Worker connections
    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }
    
    # File upload limits
    client_max_body_size 5G;
    client_body_timeout 1800s;
    client_header_timeout 1800s;
    keepalive_timeout 1800s;
    send_timeout 1800s;
    
    # Buffer sizes
    client_body_buffer_size 1M;
    client_header_buffer_size 4k;
    large_client_header_buffers 8 16k;
    
    # Include server configs
    include /etc/nginx/sites-enabled/*;
}
